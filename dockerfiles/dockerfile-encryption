# syntax=docker/dockerfile:1
FROM eclipse-temurin:21.0.7_6-jdk-alpine-3.21

LABEL name="encryptify-encryption"
LABEL maintainer="Dayfit"
LABEL description="Encryptify Encryption Service"

COPY ./.mvn /app/.mvn
COPY ./mvnw /app/mvnw

COPY ./encryptify-encryption /app/encryptify-encryption
WORKDIR /app

# Setup maven settings
RUN --mount=type=secret,id=gh_name \
    --mount=type=secret,id=github_token \
    sh -c 'echo \
"<settings>" \
"  <servers>" \
"    <server>" \
"      <id>github</id>" \
"      <username>$(cat /run/secrets/gh_name)</username>" \
"      <password>$(cat /run/secrets/github_token)</password>" \
"    </server>" \
"  </servers>" \
"</settings>" > /tmp/settings.xml'

# Compile source code
RUN \
    cd /app/encryptify-encryption && \
    ../mvnw package -DskipTests -s /tmp/settings.xml && \
    mv /app/encryptify-encryption/target/encryptify-encryption-*.jar /app/encryption.jar

CMD ["java", "-jar", "/app/encryption.jar"]

EXPOSE 8081